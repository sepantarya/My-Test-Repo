!function(l,t,m){"use strict";var a=l.wp,r=l._,p=l.TMEPOADMINLOOKUPJS,n=l.toastr,o=l.plupload,e={tc_builder_elements:a.template("tc-builder-elements"),tc_builder_section:a.template("tc-builder-section")},f=p.lookuptable;m.tmEPOAdmin={addEventsDone:0,addEvents:function(){var s,e=m("#builder_import_file"),e=new o.Uploader({url:p.ajax_url,browse_button:e[0],file_data_name:"builder_import_file",multi_selection:!1});e.init(),e.bind("FilesAdded",function(e){function t(){m("#tc-floatbox-content").find(".override-selection").addClass("tc-hidden"),o.appendTo("#tc-floatbox-content"),m(".tc-progress-info-content").html(p.i18n_importing),e.setOption("multipart_params",{action:"tc_lookup_table_import",post_id:p.post_id,security:p.import_nonce}),e.start(),m(".flasho").addClass("tc-color-notice")}var o,r=m.tmEPOAdmin.builder_floatbox_template_import({id:"tc-floatbox-content",html:"",title:p.i18n_import_title});s=m.tcFloatBox({closefadeouttime:0,animateOut:"",fps:1,ismodal:!0,refresh:"fixed",width:"50%",height:"300px",classname:"flasho tc-wrapper",data:r}),o=m('<div class="tc-progress-bar tc-notice"><span class="tc-percent"></span></div><div class="tc-progress-info"><span class="tc-progress-info-content"></span></div>'),m(".lookuptable-wrapper").length?(m('<div class="override-selection"><button type="button" class="tc tc-button details-override">'+p.i18n_overwrite_existing_tables+"</button></div>").appendTo("#tc-floatbox-content"),m(".details-override").on("click",function(){t()})):t()}),e.bind("FileUploaded",function(e,t,o){var r,a,i=m.epoAPI.util.parseJSON(o.response);i&&void 0!==i.result&&i.message&&m(".tc-progress-info-content").html(i.message),i&&i.error&&i.message&&m(".tc-progress-info-content").html(i.message),i&&void 0!==i.result&&1===m.epoAPI.math.toFloat(i.result)?(m(".tc-progress-bar").removeClass("tc-notice").addClass("tc-success"),m(".tc-progress-info-content").removeClass("tc-color-error").addClass("tc-color-success"),m(".flasho").removeClass("tc-color-notice tc-color-error").addClass("tc-color-success"),m(".floatbox-cancel").addClass("tc-hidden"),m(".tc-progress-info-content").html(p.i18n_saving),m(l).off("beforeunload.edit-post"),i.table?Array.isArray(i.jsobject)?(m(".builder-layout").html(i.table),m.tmEPOAdmin.initSectionsCheck(),n.success(i.message,p.i18n_epo),(r=m("#title")).length&&""===r.val()&&(r.val(Object.keys(i.jsobject[0])[0]),m("#title-prompt-text").addClass("screen-reader-text"),"publish"===m("#publish").attr("name")&&m("#publish").trigger("click"))):n.error(p.i18n_invalid_request,p.i18n_epo):i.different?(a=1,m(".details-override").on("click",function(){m.post(p.ajax_url,{action:"tc_lookup_table_import",import_override:1,post_id:p.post_id,security:p.import_nonce},function(e){(i=e).table&&(Array.isArray(i.jsobject)?(m(".builder-layout").html(i.table),m.tmEPOAdmin.initSectionsCheck(),n.success(i.message,p.i18n_epo)):n.error(p.i18n_invalid_request,p.i18n_epo))},"json").always(function(){s.destroy()})}),m("#tc-floatbox-content").find(".override-selection").removeClass("tc-hidden").addClass("height50").insertAfter(m(".tc-progress-info")),m(".floatbox-cancel").removeClass("tc-hidden"),m(".tc-progress-bar").addClass("tc-hidden"),m(".tc-progress-info-content").removeClass("tc-color-success tc-color-error").addClass("tc-color-notice").html(i.message),m(".flasho").removeClass("tc-color-success tc-color-error").addClass("tc-color-notice")):n.error(p.i18n_invalid_csv,p.i18n_epo),a||s.destroy()):(m(".tc-progress-bar").removeClass("tc-notice").addClass("tc-error"),m(".tc-progress-info-content").removeClass("tc-color-success").addClass("tc-color-error"),m(".flasho").removeClass("tc-color-notice tc-color-success").addClass("tc-color-error"),!i&&o&&o.response&&m(".tc-progress-info-content").addClass("tc-normalize").html(o.response),n.error(p.i18n_invalid_request,p.i18n_epo))}),e.bind("UploadProgress",function(e,t){t=parseInt(t.percent,10);m(".tc-progress-bar").css("width",t+"%"),m(".tc-percent").html(t+"%")}),e.bind("Error",function(e,t){t&&t.message&&m(".tc-progress-info-content").removeClass("tc-color-success").addClass("tc-color-error").html("\nError #"+t.code+": "+t.message),m(".tc-progress-bar").removeClass("tc-notice").addClass("tc-error"),m(".flasho").removeClass("tc-color-notice tc-color-success").addClass("tc-color-error"),t&&t.response&&(m(".flasho .header h3").html(t.message),m(".tc-progress-info-content").addClass("tc-normal-font").html(t.response)),n.error(p.i18n_invalid_request,p.i18n_epo)}),e.bind("UploadComplete",function(){m("body").removeClass("overflow")}),m(t).on("click.cpf",".tc-add-import-csv",function(e){e.preventDefault(),m("#builder_import_file").trigger("click")}),m(t).on("mouseover",".ltcell",function(){var e=m(this),t=e.parent().parent().parent(),o=e.parent().parent(),r=m(t).data("vertable")+"",a=e.data("column")+"",e=e.data("row")+" .column1";m(o).find("."+a).addClass("hov-column-"+r),m(t).find(".row.head ."+a).addClass("hov-column-head-"+r),m(t).find(".row."+e).addClass("hov-column-head-"+r)}),m(t).on("mouseout",".ltcell",function(){var e=m(this),t=e.parent().parent().parent(),o=e.parent().parent(),r=m(t).data("vertable")+"",a=e.data("column")+"",e=e.data("row")+" .column1";m(o).find("."+a).removeClass("hov-column-"+r),m(t).find(".row.head ."+a).removeClass("hov-column-head-"+r),m(t).find(".row."+e).removeClass("hov-column-head-"+r)}),m(t).on("keypress",'[contenteditable="true"]',function(e){13===e.which&&(e.preventDefault(),m(this).trigger("blur"))}),m(t).on("focus",'[contenteditable="true"]',function(){var e=m(this);e.attr("data-value",e.text())}),m(t).on("blur",'[contenteditable="true"]',function(){var e,i,s,l,n,t=m(this),o=t.text().replace(/,/g,"."),r=m.epoAPI.math.toFloat(o),a={symbol:"",format:"",decimal:""===p.tm_epo_global_displayed_decimal_separator?p.currency_format_decimal_sep:m.epoAPI.locale.getSystemDecimalSeparator(),thousand:"",precision:function e(t){var o,t=String(t);return t.includes("e-")?(o=t.split("e-"),Number(o[1])+Number(e(o[0]))):t.includes(".")?t.split(".")[1].length:0}(r)},c=t.attr("data-row"),d=t.attr("data-column"),u=t.attr("data-value");if(void 0===u&&(u=0),t.is(".table-name-value"))""===o&&t.html(u);else{if(e=t.closest("table").find("tr").length,""===o){if("1"===d||"1"===c)return void t.html(u)}else if("max"===o){if(1<Number(c)){if(Number(c)<e||1<Number(d))return void t.html(u)}else if(1===Number(c)&&Number(d)<=t.siblings().length)return void t.html(u);t.html(o)}else isNaN(r)||isNaN(Number(o))?t.html(u):(""!==o&&(o=m.epoAPI.math.format(o,a)),t.html(o));s={},l={},n={},m(".lookup-table").toArray().forEach(function(e){e=m(e),i=e.closest(".lookup-table-wrap").prev(".lookuptable-name").find(".table-name-value").text(),s[i]={},e.find(".row").toArray().forEach(function(e){m(e).find(".ltcell").toArray().forEach(function(e){var t,o,e=m(e),r=e.attr("data-row"),a=e.attr("data-column"),e=e.text();"1"===r&&"1"===a||(t=e.replace(/,/g,"."),o=m.epoAPI.math.toFloat(t),e="max"!==t&&isNaN(o)?0:t,"1"===a?n[r]=e:"1"===r?l[a]=e:(void 0===s[i][l[a]]&&(s[i][l[a]]={}),s[i][l[a]][n[r]]=e))})})}),f=s}})},tm_escape:function(e){return encodeURIComponent(e)},createLookuptableMeta:function(){var e,t=m("input#wp-preview"),o=m("#tmformfieldsbuilderwrap");r.isEqual(p.lookuptable,f)||(m(".lookuptable-meta").remove(),e=m.tmEPOAdmin.tm_escape(JSON.stringify(f)),e=m("<textarea class='lookuptable-meta tm-hidden' name='lookuptable_meta_changed'></textarea>").val(e),o.prepend(e),0<t.length&&""!==t.val()&&m(".lookuptable-meta").remove())},fixFormSubmit:function(){var r,e=m("#post");1===e.length?e.on("submit",function(){return m.tmEPOAdmin.createLookuptableMeta(),!0}):a.data&&void 0!==a.data.subscribe&&(r=!1,"function"==typeof(e=a.data.subscribe)&&e(function(){var e,t,o;a.data.select("core/editor")&&(t=a.data.select("core/editor").didPostSaveRequestSucceed(),o=a.data.select("core/editor").didPostSaveRequestFail(),a&&a.data&&a.data.select("core/editor")&&(e=a.data.select("core/editor").isSavingPost()),!r&&e&&(r=!0,m.tmEPOAdmin.createLookuptableMeta()),r&&(t||o)&&(r=!1,setTimeout(function(){m(".lookuptable-meta").remove()},600)))}))},initialitize:function(){m.tmEPOAdmin.initSectionsCheck(),m.tmEPOAdmin.addEvents(),m(".builder-layout").removeClass("tm-hidden"),m.tmEPOAdmin.fixFormSubmit()},initSectionsCheck:function(){m(".lookuptable-wrapper").length?(m(".builder-add-section-action").show(),m(".builder-selector").show(),m(".tc-welcome").hide(),m(".builder-layout").show()):(m(".builder-add-section-action").hide(),m(".builder-selector").hide(),m(".tc-welcome").show(),m(".builder-layout").hide())},builder_floatbox_template:function(e,t){return m.epoAPI.template.html(a.template(t||"tc-floatbox"),{id:e.id,title:e.title,html:e.html,uniqidtext:e.uniqidtext||"",uniqid:e.uniqid,update:e.update||p.i18n_update,cancel:e.cancel||p.i18n_cancel})},builder_floatbox_template_import:function(e){return m.epoAPI.template.html(a.template("tc-floatbox-import"),{id:e.id,title:e.title,html:e.html,cancel:p.i18n_cancel})}},m(function(){e=m.epoAPI.applyFilter("tc_adjust_admin_template_engine",e),m.tmEPOAdmin.initialitize()})}(window,document,window.jQuery);